{% extends "base.html" %}
{% block content %}
<div class="container my-4">

  <h2 class="mb-4">{{ lang.get("dashboard_title","Dashboard") }}</h2>

  <!-- Top Action Buttons -->
  <div class="d-flex flex-wrap gap-2 mb-4">
    <a href="{{ url_for('recommend_page') }}" class="btn btn-primary btn-lg hover-scale me-2">New Crop Recommendation</a>
    <a href="{{ url_for('disease_page') }}" class="btn btn-warning btn-lg hover-scale me-2">Detect Crop Disease</a>
  </div>

  <!-- Soil Records Section -->
  <h4 class="mb-3">Recent Soil Records</h4>
  <div class="row g-3">
    {% for rec in history %}
    <div class="col-md-6 col-lg-4">
      <div class="card shadow-sm hover-scale position-relative">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
          <span>{{ rec.recorded_at.strftime('%Y-%m-%d') }}</span>
          <form method="post" action="{{ url_for('delete_history', id=rec.id) }}">
            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
          </form>
        </div>
        <div class="card-body p-2">
          <p class="mb-1"><strong>N:</strong> <span class="text-primary">{{ rec.n }}</span></p>
          <p class="mb-1"><strong>P:</strong> <span class="text-warning">{{ rec.p }}</span></p>
          <p class="mb-1"><strong>K:</strong> <span class="text-danger">{{ rec.k }}</span></p>
          <p class="mb-1"><strong>pH:</strong> {{ rec.ph }}</p>
          <p class="mb-1"><strong>Temp:</strong> {{ rec.weather_temp }}Â°C</p>
          <p class="mb-1"><strong>Humidity:</strong> {{ rec.weather_humidity }}%</p>
          <p class="mb-1"><strong>Rainfall:</strong> {{ rec.rainfall }}mm</p>
          <p class="mb-0"><strong>Predicted Crop:</strong> <span class="fw-bold">{{ rec.crop_predicted }}</span></p>
        </div>
      </div>
    </div>
    {% else %}
    <div class="col-12">
      <div class="alert alert-info text-center">No records yet.</div>
    </div>
    {% endfor %}
  </div>

</div>

<!-- Floating Chat Widget -->
<div id="chat-widget" class="chat-widget">
  <div class="chat-header bg-primary text-white d-flex justify-content-between align-items-center px-3 py-2">
    <span>AgriNext AI Assistant ðŸ¤–</span>
    <button id="chat-close" class="btn btn-sm btn-light">âœ•</button>
  </div>
  <div id="chat-messages" class="chat-messages p-3"></div>
  <div class="chat-input d-flex p-2 border-top">
    <input id="chat-input" type="text" class="form-control me-2" placeholder="Ask me anything...">
    <button id="chat-send" class="btn btn-primary">Send</button>
  </div>
</div>

<button id="chat-toggle" class="btn btn-primary chat-toggle">ðŸ’¬ Chat</button>

<style>
.hover-scale:hover {
  transform: scale(1.03);
  transition: 0.3s;
}
.chat-widget {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 80%;
  max-width: 800px;
  height: 80%;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  display: none;
  flex-direction: column;
  z-index: 1050;
}
.chat-header {
  font-weight: bold;
  border-bottom: 1px solid #ddd;
  border-radius: 12px 12px 0 0;
}
.chat-messages {
  flex: 1;
  overflow-y: auto;
  font-size: 14px;
}
.chat-input {
  border-radius: 0 0 12px 12px;
}
.chat-toggle {
  position: fixed;
  bottom: 20px;
  right: 20px;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  font-size: 24px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  z-index: 1100;
}
.chat-message {
  margin-bottom: 10px;
}
.chat-message.user {
  text-align: right;
}
.chat-message.bot {
  text-align: left;
  color: green;
}
</style>

<script>
const widget = document.getElementById("chat-widget");
const toggleBtn = document.getElementById("chat-toggle");
const closeBtn = document.getElementById("chat-close");
const sendBtn = document.getElementById("chat-send");
const inputBox = document.getElementById("chat-input");
const messages = document.getElementById("chat-messages");

toggleBtn.addEventListener("click", () => widget.style.display = "flex");
closeBtn.addEventListener("click", () => widget.style.display = "none");

sendBtn.addEventListener("click", sendMessage);
inputBox.addEventListener("keypress", e => { if (e.key === "Enter") sendMessage(); });

function sendMessage() {
  const text = inputBox.value.trim();
  if (!text) return;

  // Add user message
  messages.innerHTML += `<div class="chat-message user"><b>You:</b> ${text}</div>`;
  inputBox.value = "";
  messages.scrollTop = messages.scrollHeight;

  fetch("/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ message: text })
  })
  .then(res => res.json())
  .then(data => {
    if (data.reply) {
      messages.innerHTML += `<div class="chat-message bot"><b>AI:</b> ${data.reply}</div>`;
      messages.scrollTop = messages.scrollHeight;
    } else {
      messages.innerHTML += `<div class="chat-message bot text-danger"><b>Error:</b> Could not fetch reply.</div>`;
    }
  })
  .catch(() => {
    messages.innerHTML += `<div class="chat-message bot text-danger"><b>Error:</b> Server issue.</div>`;
  });
}
</script>
{% endblock %}
